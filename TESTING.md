# Тестовая стратегия

Документ описывает процесс тестирования и управление качеством программного обеспечения.

## 1. Краткое описание проекта

Проект представляет собой MCP-сервер, реализованный на Node.js. 
Код проекта располагается в приватном репозитории [Artsofte](https://artsofte.ru/) и является интеллектуальной собственностью компании.
В данном репозитории перенесено часть методов итогового решения, а также вместо их кода используется заглушки.

Код проекта: `src/*`.  
Тесты проекта `tests/*`

## 2. Роли и зона ответственности
Роли распределяются следующим образом:

- **QA Team Lead**
    - Формулирует тестовую стратегию.
    - Определяет, какие виды тестов обязательны для каждого Pull Request.
    - Анализирует результаты тестов в CI и ручного тестирования.
    - Принимает финальное решение об слиянии изменений в ветку `main`.

- **Developers**
    - Реализуют функциональность сервера.
    - Пишут и поддерживают юнит тесты, размещённые в `tests/dev/`.
    - Перед открытием отправкой правок запускают тесты локально.

- **QA Engineers**
    - Отвечают за функциональные/контрактные тесты, размещённые в `tests/qa/`.
    - Проводят ручное функциональное и регрессионное тестирование через клиент (LM Studio).
    - Заводят и описывают дефекты на доске Trello.

- **Project Manager**
    - Учитывает результаты отчётов и принимает решение о релизе версии.
    - Отвечает за сроки и требования к качеству.

## 3. Область тестирования

В область тестирования входят:

- Регистрация и базовое поведение MCP-инструментов:
    - `index`
    - `clean_index`
    - `get_graph`
    - `get_graph_stats`
    - `get_graph_health`
    - `list_file_entities`
    - `list_entity_relationships`
    - `semantic_search`
    - `query`
    - `analyze_code_impact`
    - `detect_code_clones`
- Структура возвращаемого ответа:
    - поле `tool` с именем вызванного инструмента;
    - флаг `stub`, показывающий, что это заглушка;
    - текстовое поле `message` с описанием результата;
    - поле `receivedArgs` с аргументами вызова.
- Интеграция автотестов в процесс CI с помощью GitHub Actions.

## 4. Типы тестов

### 4.1. Unit-тесты (Developer)

Цель: проверить поведение отдельных функций и небольших участков кода в изоляции.

В проекте unit-тесты сконцентрированы на:

- функции `createStubResult`;
- проверке соответствия структуры ожидаемой схеме Zod.

Расположение: `tests/dev/*`.  
Запуск: `npm run test:dev`.

### 4.2. Функциональные контрактные тесты (QA)

Цель: убедиться, что все инструменты MCP-сервера возвращают ответы в едином формате.

В проекте проверяется, что для каждого инструмента:
- поле `tool` совпадает с именем инструмента;
- поле `stub` имеет значение `true`;
- поле `message` содержит информацию об успешном выполнении;
- поле `receivedArgs` в точности повторяет переданные аргументы.

Расположение: `tests/qa/*`.  
Запуск: `npm run test:qa`.

### 4.3. Ручное функциональное и регрессионное тестирование

QA Engineers выполняют ручное тестирование через MCP-клиент:

- проверяют, что инструменты корректно регистрируются и видны клиенту;
- вызывают ключевые инструменты (`index`, `get_graph`, `semantic_search`);
- подтверждают, что ответы соответствуют контракту, зафиксированному в тестах.


## 5. Интеграция автотестов в CI/CD

Для автоматизации тестирования используется GitHub Actions.

Workflow-файл: [test.yml](.github/workflows/test.yml).

Основные принципы:

- Запуск тестов происходит автоматически:
    - при каждом `push` в ветки `develop` и `main`;
    - при каждом Pull Request в `develop` или `main`.
- Шаги запуска:
    - установка зависимостей `npm ci`;
    - запуск developer-тестов: `npm run test:dev`;
    - запуск QA-тестов: `npm run test:qa`.

Успешное завершение всех шагов workflow - обязательное условие для слияния Pull Request.

## 6. Правила quality gate и merge approval

Для ветки `main` включена защита ветки:

- запрещены прямые `push` в `main`;
- изменения только через Pull Request
- права на мерж в main есть только у **QA Team Lead**.

Процесс принятия изменений:

1. Разработчик пишет код согласно [CONTRIBUTING.md](CONTRIBUTING.md).
2. На написанный код добавляются новые тесты.
3. Открывает Pull Request.
4. CI автоматически запускает тесты.  
   Если хотя бы один из тестов завершился с ошибкой, мерж блокируется до устранения.
5. QA Engineers при необходимости выполняют ручное тестирование и фиксируют результаты в комментарии.
6. QA Team Lead:
    - проверяет результаты автотестов и ручного тестирования;
    - принимает решение об одобрении или отклонении изменений.

* Без одобрения QA Team Lead и успешного прохождения всех тестов Pull Request не мёржится в `main`.

## 7. Метрики качества и улучшения

Для оценки качества и развития процесса отслеживаются следующие показатели:

- **Прохождение автотестов в CI**
    - процент успешных выполнения тестов ко всем;
    - наличие и устранение нестабильных (flaky) тестов.

- **Покрытие тестами ключевых участков логики**
    - наличие unit-тестов для основного функционала;
    - наличие функциональных тестов при необходимости.

- **Дефекты**
    - количество дефектов в рамках ручного тестирования;
    - время реакции на дефекты, от заведения в Trello до исправления.

На основании этих метрик QA Team Lead формулирует предложения по улучшению процесса:

- добавление интеграционных тестов;
- расширение набора функциональных тестов по инструментам;
- оптимизация времени выполнения тестов в CI при росте проекта.

## 8. Итог

Стратегия описывает полноценный процесс обеспечения качества проекта:
- распределены роли и ответственности;
- определены виды тестов и зона ответственности;
- автотесты интегрированы в CI;
- описан набор метрик для принятия решений.
